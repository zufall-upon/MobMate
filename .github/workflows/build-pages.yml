name: Build GitHub Pages

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pandoc
        run: sudo apt-get install -y pandoc

      - name: Convert README.md to HTML body
        run: |
          pandoc README.md \
            --from markdown \
            --to html \
            --no-highlight \
            --wrap=none \
            -o /tmp/readme_body.html

      - name: Inject into template
        run: |
          sed '/<!-- CONTENT -->/{
            r /tmp/readme_body.html
            d
          }' docs/index.template.html > docs/index.html

      - name: Commit generated index.html
        run: |
          if git diff --quiet; then
            echo "No changes"
          else
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git add docs/index.html
            git commit -m "Update docs/index.html from README.md"
            git push
          fi
